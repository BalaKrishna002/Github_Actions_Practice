name: SQS Stuck Messages Report

on:
  schedule:
  # 9:00 AM IST = 03:30 UTC
    - cron: '30 3 * * *'

  # Manual trigger
  workflow_dispatch:
    inputs:
      note:
        description: 'Optional note for manual run'
        required: false


jobs:
  send_sqs_report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install boto3 pandas yagmail pytz

      - name: Generate SQS Stuck Messages Report
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: 'us-west-2'
          EMAIL_USER: ${{ secrets.GMAIL_USERNAME }}
          EMAIL_PASS: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: |
          python <<EOF
          import boto3
          import pandas as pd
          import yagmail
          from datetime import datetime, timedelta
          import pytz
          import os

          # Timezone
          ist = pytz.timezone('Asia/Kolkata')
          now_ist = datetime.now(ist)

          # Define time window: 1:00 AM to 5:00 AM IST today
          start_time = ist.localize(datetime(now_ist.year, now_ist.month, now_ist.day, 1, 0))
          end_time = ist.localize(datetime(now_ist.year, now_ist.month, now_ist.day, 5, 0))

          # Convert to UTC for CloudWatch
          start_utc = start_time.astimezone(pytz.UTC)
          end_utc = end_time.astimezone(pytz.UTC)

          queues = [
              'https://sqs.us-west-2.amazonaws.com/189675173661/AggregationReadyUsersPriority-nonprodqa-01'
          ]

          cw = boto3.client('cloudwatch', region_name=os.environ['AWS_REGION'])

          report = []

          for queue_url in queues:
              queue_name = queue_url.split('/')[-1]

              sent_metric = cw.get_metric_statistics(
                  Namespace='AWS/SQS',
                  MetricName='NumberOfMessagesSent',
                  Dimensions=[{'Name':'QueueName', 'Value': queue_name}],
                  StartTime=start_utc,
                  EndTime=end_utc,
                  Period=3600*4,
                  Statistics=['Sum']
              )

              received_metric = cw.get_metric_statistics(
                  Namespace='AWS/SQS',
                  MetricName='NumberOfMessagesReceived',
                  Dimensions=[{'Name':'QueueName', 'Value': queue_name}],
                  StartTime=start_utc,
                  EndTime=end_utc,
                  Period=3600*4,
                  Statistics=['Sum']
              )

              messages_sent = int(sent_metric['Datapoints'][0]['Sum']) if sent_metric['Datapoints'] else 0
              messages_received = int(received_metric['Datapoints'][0]['Sum']) if received_metric['Datapoints'] else 0
              messages_stuck = max(messages_sent - messages_received, 0)

              report.append({
                  'Queue Name': queue_name,
                  'Messages Sent': messages_sent,
                  'Messages Received': messages_received,
                  'Messages Stuck': messages_stuck
              })

          df = pd.DataFrame(report)
          html_table = df.to_html(index=False)

          yag = yagmail.SMTP(user=os.environ['EMAIL_USER'], password=os.environ['EMAIL_PASS'])
          yag.send(
              to=os.environ['EMAIL_USER'],
              subject='SQS Stuck Messages Report (1:00-5:00 AM IST)',
              contents=f"<h3>SQS Messages Stuck Report (1:00-5:00 AM IST)</h3>{html_table}"
          )
          print("Email sent successfully!")
          EOF

