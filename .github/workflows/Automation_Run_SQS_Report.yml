name: SQS Report Email

on:
  # schedule:
    # Runs at 9:15 AM IST (3:45 AM UTC) every day
    # - cron: '45 3 * * *'
  workflow_dispatch:
    inputs:
      date:
        description: 'Specific date (dd-mm-yyyy) or leave empty for today'
        required: false
        type: string
      from_date:
        description: 'Start date for range (dd-mm-yyyy)'
        required: false
        type: string
      to_date:
        description: 'End date for range (dd-mm-yyyy)'
        required: false
        type: string

jobs:
  generate-and-send-report:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install boto3 pandas pytz
        
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-west-2
        
    - name: Generate SQS Report
      id: generate_report
      run: |
        # Determine the command to run based on inputs
        if [ -n "${{ github.event.inputs.date }}" ]; then
          python sqs_analysis_for_all_nonprodqa.py "${{ github.event.inputs.date }}"
        elif [ -n "${{ github.event.inputs.from_date }}" ] && [ -n "${{ github.event.inputs.to_date }}" ]; then
          python sqs_analysis_for_all_nonprodqa.py --from "${{ github.event.inputs.from_date }}" --to "${{ github.event.inputs.to_date }}"
        else
          # Default: run for today
          python sqs_analysis_for_all_nonprodqa.py
        fi
        
        # Find the generated HTML file
        HTML_FILE=$(ls sqs_report_*.html | head -1)
        echo "html_file=$HTML_FILE" >> $GITHUB_OUTPUT
        
        # Extract the HTML table content (everything inside the container div)
        python3 << 'EOF'
        import re
        import os
        
        html_file = os.environ.get('HTML_FILE', '')
        if not html_file:
            html_files = [f for f in os.listdir('.') if f.startswith('sqs_report_') and f.endswith('.html')]
            html_file = html_files[0] if html_files else ''
        
        if html_file:
            with open(html_file, 'r', encoding='utf-8') as f:
                content = f.read()
            
            # Extract content inside the container div
            match = re.search(r'<div class="container">(.*?)</div>\s*</body>', content, re.DOTALL)
            if match:
                table_content = match.group(1).strip()
                
                # Create email-friendly HTML with inline styles
                email_html = f'''
        <div style="font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; background-color: white; padding: 20px;">
        {table_content}
        </div>
        '''
                
                # Save to file for email
                with open('email_content.html', 'w', encoding='utf-8') as f:
                    f.write(email_html)
                
                print(f"Email content extracted from {html_file}")
            else:
                print("Could not extract table content")
        else:
            print("No HTML file found")
        EOF
      env:
        HTML_FILE: ${{ steps.generate_report.outputs.html_file }}
        
    - name: Send Email
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.GMAIL_USERNAME }}
        password: ${{ secrets.GMAIL_APP_PASSWORD }}
        subject: "SQS Report - ${{ github.event.inputs.date || 'Today' }}"
        to: balakrishnam@bidgely.com
        from: ${{ secrets.GMAIL_USERNAME }}
        html_body: file://email_content.html
        
    - name: Upload HTML Report as Artifact
      uses: actions/upload-artifact@v3
      with:
        name: sqs-report-html
        path: sqs_report_*.html
        retention-days: 30
